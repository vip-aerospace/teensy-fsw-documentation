<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ke Ao Teensy Flight Software: Start Here</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Ke Ao Teensy Flight Software
   </div>
   <div id="projectbrief">The software on the Teensy in the Ke Ao cubesat.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Start Here </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Introduction"></a>
Introduction</h1>
<p>This is the documentation on the Flight Software (FSW) that runs on the Teensy microcontroller in the Ke Ao CubeSat's On-Board Computer (OBC) board. This page is designed to give a high- level understanding of the FSW and introduce essential computing concepts that the FSW uses.</p>
<h1><a class="anchor" id="Teensy"></a>
The Teensy</h1>
<p>This code runs on the <a href="https://www.pjrc.com/store/teensy41.html">Teensy 4.1 microcontroller</a>. As the link shows, this is a very capable microcontroller. If you are familiar with <a href="https://www.arduino.cc/en/Guide/Introduction">Arduino</a>, the Teensy is very similar. You can think of the Teensy as a souped-up Arduino, with more ports and processing power.</p>
<p>There are many ways to program a Teensy. This project uses the PlatformIO IDE within Visual Studio Code. This allows us to use a more powerful IDE than Arduino IDE (which is still great for prototyping!). Make sure you follow the instructions in the <a class="el" href="development_environment_setup.html">Development Environment Setup Guide</a> in order to program the Teensy.</p>
<h1><a class="anchor" id="HighLevel"></a>
A High-Level Understanding of the FSW</h1>
<p>This section will give an overview of the FSW, how it works, and its functional components.</p>
<p>The Teensy, as mentioned earlier, is essentially a powerful Arduino. The FSW is built on the Arduino's programming principles. That is, there is a <code><a class="el" href="main_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d" title="Initialization code.">setup()</a></code> function that is called once, followed by a <code><a class="el" href="main_8cpp.html#afe461d27b9c48d5921c00d521181f12f" title="Operating code.">loop()</a></code> function that runs in an infinite loop, forever. These links are to the functions in the <a class="el" href="main_8cpp.html" title="The main operating loop for the Teensy.">main.cpp</a> file, and are the starting point for the code. In essence, this is the top-level Arduino code, the same as any other Arduino sketch.</p>
<p>It could be possible to put all our code into this one file, but this would be a massive file that would be hard to read and maintain. In addition, we want to be able to seperate the code based on what components of the CubeSat it effects.</p>
<p>As a result, we split up the codebase and execution using <a class="el" href="index.html#Multithreading">multithreading. </a> Each thread (we call them channels in our implementation) is responsible for some component of the CubeSat, such as the radios, sensors, or PDU. <a class="el" href="classA.html">A</a> brief description of each channel is given below.</p>
<ul>
<li>main_channel: Technically, this channel is not listed in the code. That is because this is the first channel that is started when the Teensy is first powered on. Even though it is not explicitly defined, the Teensy switches to it like any other channel and executes its code. It does the following:<ul>
<li>It acts as a "router" for PacketComm packets. Incoming packets are sent to the <a class="el" href="artemis__defs_8h.html#ae77a939baa88784acde567432857faac">main_queue</a>, which then are sent to the appropriate channel for handling.</li>
<li>It polls the built-in sensors that are not handled by a channel (such as the temperature, current, and IMU sensors) for their readings.</li>
<li>It generates PacketComm packets for testing other channels.</li>
<li>It creates every other channel and allocates computing time to them.</li>
</ul>
</li>
<li><a class="el" href="artemis__channels_8h.html#a8b4467ddf4e8fa186d4ff935b5efd682">astrodev_channel(): </a> Controls the Astrodev (Lithium-3) radio. It does the following:<ul>
<li>It configures and connects to the Astrodev radio.</li>
<li>It handles incoming transmissions containing PacketComm packets, and adds those packets to the <a class="el" href="artemis__defs_8h.html#ae77a939baa88784acde567432857faac">main_queue</a>.</li>
<li>It transmits outgoing PacketComm packets from its <a class="el" href="artemis__defs_8h.html#af84bb624ddc22f5e1c52dce692eb72b5">astrodev_queue</a>.</li>
</ul>
</li>
<li><a class="el" href="artemis__channels_8h.html#a7887cfbca4d664c4704f5f51341a67e8">rfm23_channel(): </a> Controls the HopeRF RFM23 radio. It does the following:<ul>
<li>It configures and connects to the RFM23 radio.</li>
<li>It handles incoming transmissions containing PacketComm packets, and adds those packets to the <a class="el" href="artemis__defs_8h.html#ae77a939baa88784acde567432857faac">main_queue</a>.</li>
<li>It transmits outgoing PacketComm packets from its <a class="el" href="artemis__defs_8h.html#aba61200a48a4acd00dc3dcc14c32ee09">rfm23_queue</a>.</li>
</ul>
</li>
<li><a class="el" href="artemis__channels_8h.html#a67591550cbab03372e6c350413f9e55d">rfm98_channel(): </a> Controls the HopeRF RFM98 LoRa radio. It does the following:<ul>
<li>It configures and connects to the RFM98 radio.</li>
<li>It handles incoming transmissions containing PacketComm packets, and adds those packets to the <a class="el" href="artemis__defs_8h.html#ae77a939baa88784acde567432857faac">main_queue</a>.</li>
<li>It transmits outgoing PacketComm packets from its <a class="el" href="artemis__defs_8h.html#a6de4a2d03fcc47b4700ee43a08c755ed">rfm98_queue</a>.</li>
</ul>
</li>
<li><a class="el" href="artemis__channels_8h.html#ab6711bb03336935d478df50858d432cc">pdu_channel(): </a> Controls Ke Ao's Power Distribution Unit (PDU). It does the following:<ul>
<li>It connects to the PDU's built-in microcontroller.</li>
<li>It gets switch states on the PDU.</li>
<li>It sets switch states on the PDU.</li>
</ul>
</li>
<li><a class="el" href="artemis__channels_8h.html#a17a76e9f49ef431b43f14490b2b88d05">rpi_channel(): </a> Communicates with the Raspberry Pi (RPi) on Ke Ao's OBC.<ul>
<li>It connects to the RPi.</li>
<li>It sends Astrodev packets to the RPi.</li>
<li>It receives Astrodev packets from the RPi.</li>
<li>It can command the RPi to power down.</li>
</ul>
</li>
</ul>
<p>As the descriptions show, each channel runs independently, sharing information in the form of PacketComm packets inserted into each others' queues. At a high level, the Teensy flips through these channels quickly, executing a little bit of each channel before moving on to the next channel. The code must therefore be written with the assumption that it may be interrupted at any time. Further information is given in the multithreading section. <br  />
</p>
<h1><a class="anchor" id="BuildFlags"></a>
PlatformIO Build Flags</h1>
<p>This section describes the PlatformIO build flags and their uses.</p>
<p>We can take advantage of the build flags feature of PlatformIO to selectively compile the code for testing and debugging. The build flags are found in the platformio.ini file in the root directory of the code. They are listed on individual lines, like so: </p><pre class="fragment">build_flags = 
    -D COSMOS_MICRO_COSMOS
    -D TEST_PACKETS
    -D DEBUG_PRINT
;   -D DEBUG_PRINT_TIMEOUT
;   -D DEBUG_PRINT_HEXDUMP</pre><p>The <code>;</code> symbol comments out a flag, disabling it.</p>
<h2><a class="anchor" id="Tests"></a>
Tests</h2>
<p>These flags are used to run test code, generating test data to see how the program handles incoming data.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag Name   </th><th class="markdownTableHeadNone">Function    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">TEST_PACKETS   </td><td class="markdownTableBodyNone">Enable to generate test PacketComm packets as defined in <a class="el" href="packet__tests_8h.html">packet_tests.h</a>.   </td></tr>
</table>
<h2><a class="anchor" id="DebugFlags"></a>
Debug Flags</h2>
<p>If you've used Arduino before, you might be familiar with the <code>Serial.print()</code> style of debugging. We use the same method of debugging in this project for simplicity. When enabled, the Teensy will print debug statements over the Serial connection established over USB to the Terminal in VSCode.</p>
<p>Multiple flags are available for use, depending on what statements you'd like to print. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag Name   </th><th class="markdownTableHeadNone">Function    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DEBUG_PRINT   </td><td class="markdownTableBodyNone">Enable to print debug messages to the Terminal.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">DEBUG_PRINT_TIMEOUT   </td><td class="markdownTableBodyNone">Enable to print messages that the Astrodev radio has been polled for data but does not reply before timeout.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DEBUG_PRINT_HEXDUMP   </td><td class="markdownTableBodyNone">Enable to print hexdumps of Astrodev packets to serial console.   </td></tr>
</table>
<h1><a class="anchor" id="Multithreading"></a>
Understanding Multithreading</h1>
<p>Although the Teensy is a powerful microcontroller, it does have limitations. In particular, it only has a single CPU to execute instructions. Despite this, we want the Teensy (and Ke Ao) to do multiple things at the same time (known as multitasking).</p>
<p>To accomplish this, we use a technique known as multithreading. In multithreading, a program (such as the FSW) creates multiple smaller programs (called "threads") that are switched between in order to execute different parts of a program nearly simultaneously.</p>
<p>The specific implementation that the FSW uses is based on the <a href="https://github.com/ftrias/TeensyThreads">TeensyThreads library</a>. In the FSW, we call threads "channels", and we switch between these channels as the program proceeds. The main channel is the channel that is started when the Teensy is powered on. It creates a channel for each functional part of Ke Ao, and switches between these channels (and itself) based on the computing time assigned to each channel.</p>
<h2><a class="anchor" id="Mutexes"></a>
Mutual Exclusions (Mutexes)</h2>
<p>Each channel is defined in its own file, and essentially behaves as its own independent Arduino sketch. In theory, this is all that is needed to implement multitasking. However, it is not this simple. Just because the channel is the currently active one, does not mean that it has exclusive access to all of the Teensy's hardware.</p>
<p>Consider this example. Channel <a class="el" href="classA.html">A</a> uses the Teensy's I2C connection to communicate with a serial device (say, a radio). I2C is a bus-based system, where all devices are connected to the same data bus, and it is up to the Teensy to specify which device on the bus it wishes to communicate with. Now Channel <a class="el" href="classA.html">A</a> initiates a connection to the radio, indicating that it will send data to the radio to transmit. However, Channel <a class="el" href="classA.html">A</a>'s computing time runs out before it can actually send the data that it wants to transmit.</p>
<p>Channel <a class="el" href="classB.html">B</a> is up next, and it polls a temperature sensor over the same I2C connection. The Teensy keeps the I2C connection active and sends a request addressed to the sensor. However, the radio interpets the data in its entirety to be the data to transmit, and incorrectly transmits the request. (In reality, there are other safeguards against this, but this illustrates the problem)</p>
<p>This type of error is due to collisions in shared resources. These resources could be pins on the Teensy, serial connections, shared memory, etc. To avoid these collisions, we use mutual exclusions (mutexes).</p>
<p><a class="el" href="classA.html">A</a> mutex is essentially a token that ensures that a given channel (thread) is the only one that has access to a resource. It is "locked" when a channel claims access to a resource, and is "unlocked" when the channel is done using the resource. Importantly, if one channel has a mutex locked, it will retain exclusive access to that resource even if that channel is not being actively executed. Thus, if another channel wants to lock that mutex, it will either fail outright or wait until the mutex is no longer locked (depending on the specific implementation).</p>
<h2><a class="anchor" id="MultithreadingAnalogy"></a>
An Analogy</h2>
<p>To illustrate this, try this analogy. You have multiple homework assignments for different classes (say Calculus, Circuits, Physics and English). You procrastinated, so they're all due at the same time and there's no time to complete all of them. You could do each individually and in sequence. That is, you complete all Calculus problems, then Circuits, etc. This would allow you to complete all of the Calculus, Circuits, and Physics problems, but you wouldn't have any time to even start the English paper.</p>
<p>You decide to implement a multitasking approach based on multithreading. You set an alarm to go off every 20 minutes, and work on one assignment at a time in that interval. If the alarm goes off, you switch to the next assignment, even if you are in the middle of a problem.</p>
<p>This approach works well and you get a little bit of each assignment done. However, you're working on a Calculus problem, using your calculator, when the alarm goes off! The next assignment is a Circuits program that also requires a calculator. You can't reset or clear the calculator (it has the values you were working on for Calculus), so you skip to the next Circuits problem, noting that you should return to the previous problem when you have access to the calculator again.</p>
<p>You skip forward to Physics. It's a short assignment, so you complete it quickly. You can take the rest of the time you allocated to Physics and idle (do nothing). You then do some of the English paper, then return to Calculus. You complete the problem and release the calculator. You then switch to Physics, now able to use the calculator now that it is free for your use.</p>
<p>This gives a simplified view of what the Teensy's processor is doing when using multithreading. As you can see, computers are much better at multitasking than humans. Even so, just as a human requires time to "get up to speed" on each transition from one task to another, a computer has a performance penalty for switching between threads. This performance hit is negligible for our purposes, but it does exist. (For those interested in computer architecture, the processor must flush and refill its cache when switching between threads) </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
